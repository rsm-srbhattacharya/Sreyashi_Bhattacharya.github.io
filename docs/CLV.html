<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.506">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sreyashi Bhattacharya - Customer Lifetime Value Prediction for Automobile Insurance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Sreyashi Bhattacharya</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> <i class="bi bi-person-circle" role="img">
</i> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./resume.html"> <i class="bi bi-file-earmark-check" role="img">
</i> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./data-analysis.html"> <i class="bi bi-bar-chart" role="img">
</i> 
<span class="menu-text">Data Analysis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./statistics.html"> <i class="bi bi-calculator" role="img">
</i> 
<span class="menu-text">Statistics</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#final-model---1" id="toc-final-model---1" class="nav-link active" data-scroll-target="#final-model---1">Final Model - 1</a></li>
  <li><a href="#final-model---2" id="toc-final-model---2" class="nav-link" data-scroll-target="#final-model---2">Final Model - 2</a></li>
  <li><a href="#final-model---3" id="toc-final-model---3" class="nav-link" data-scroll-target="#final-model---3">Final Model - 3</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Customer Lifetime Value Prediction for Automobile Insurance</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Data Source - https://www.kaggle.com/code/dktalaicha/predict-customer-life-time-value-clv</p>
<div id="cell-3" class="cell" data-editable="true" data-slideshow="{&quot;slide_type&quot;:&quot;&quot;}" data-tags="[]" data-execution_count="62">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading the dataset</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'dataset.csv'</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying the first few rows of the dataset, its shape and info</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>data_info <span class="op">=</span> data.info()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>data_head <span class="op">=</span> data.head()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>data_shape <span class="op">=</span> data.shape</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>data_head, data_shape, data_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 9134 entries, 0 to 9133
Data columns (total 24 columns):
 #   Column                         Non-Null Count  Dtype  
---  ------                         --------------  -----  
 0   Customer                       9134 non-null   object 
 1   State                          9134 non-null   object 
 2   Customer Lifetime Value        9134 non-null   float64
 3   Response                       9134 non-null   object 
 4   Coverage                       9134 non-null   object 
 5   Education                      9134 non-null   object 
 6   Effective To Date              9134 non-null   object 
 7   EmploymentStatus               9134 non-null   object 
 8   Gender                         9134 non-null   object 
 9   Income                         9134 non-null   int64  
 10  Location Code                  9134 non-null   object 
 11  Marital Status                 9134 non-null   object 
 12  Monthly Premium Auto           9134 non-null   int64  
 13  Months Since Last Claim        9134 non-null   int64  
 14  Months Since Policy Inception  9134 non-null   int64  
 15  Number of Open Complaints      9134 non-null   int64  
 16  Number of Policies             9134 non-null   int64  
 17  Policy Type                    9134 non-null   object 
 18  Policy                         9134 non-null   object 
 19  Renew Offer Type               9134 non-null   object 
 20  Sales Channel                  9134 non-null   object 
 21  Total Claim Amount             9134 non-null   float64
 22  Vehicle Class                  9134 non-null   object 
 23  Vehicle Size                   9134 non-null   object 
dtypes: float64(2), int64(6), object(16)
memory usage: 1.7+ MB</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>(  Customer       State  Customer Lifetime Value Response  Coverage Education  \
 0  BU79786  Washington              2763.519279       No     Basic  Bachelor   
 1  QZ44356     Arizona              6979.535903       No  Extended  Bachelor   
 2  AI49188      Nevada             12887.431650       No   Premium  Bachelor   
 3  WW63253  California              7645.861827       No     Basic  Bachelor   
 4  HB64268  Washington              2813.692575       No     Basic  Bachelor   
 
   Effective To Date EmploymentStatus Gender  Income  ...  \
 0           2/24/11         Employed      F   56274  ...   
 1           1/31/11       Unemployed      F       0  ...   
 2           2/19/11         Employed      F   48767  ...   
 3           1/20/11       Unemployed      M       0  ...   
 4            2/3/11         Employed      M   43836  ...   
 
   Months Since Policy Inception Number of Open Complaints  Number of Policies  \
 0                             5                         0                   1   
 1                            42                         0                   8   
 2                            38                         0                   2   
 3                            65                         0                   7   
 4                            44                         0                   1   
 
       Policy Type        Policy  Renew Offer Type  Sales Channel  \
 0  Corporate Auto  Corporate L3            Offer1          Agent   
 1   Personal Auto   Personal L3            Offer3          Agent   
 2   Personal Auto   Personal L3            Offer1          Agent   
 3  Corporate Auto  Corporate L2            Offer1    Call Center   
 4   Personal Auto   Personal L1            Offer1          Agent   
 
   Total Claim Amount  Vehicle Class Vehicle Size  
 0         384.811147   Two-Door Car      Medsize  
 1        1131.464935  Four-Door Car      Medsize  
 2         566.472247   Two-Door Car      Medsize  
 3         529.881344            SUV      Medsize  
 4         138.130879  Four-Door Car      Medsize  
 
 [5 rows x 24 columns],
 (9134, 24),
 None)</code></pre>
</div>
</div>
<div id="cell-4" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Descriptive statistics of the dataset</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>descriptive_stats <span class="op">=</span> data.describe(include<span class="op">=</span><span class="st">'all'</span>).transpose()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying the descriptive statistics</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>descriptive_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">unique</th>
<th data-quarto-table-cell-role="th">top</th>
<th data-quarto-table-cell-role="th">freq</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Customer</td>
<td>9134</td>
<td>9134</td>
<td>BU79786</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">State</td>
<td>9134</td>
<td>5</td>
<td>California</td>
<td>3150</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Customer Lifetime Value</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>8004.940475</td>
<td>6870.967608</td>
<td>1898.007675</td>
<td>3994.251794</td>
<td>5780.182197</td>
<td>8962.167041</td>
<td>83325.38119</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Response</td>
<td>9134</td>
<td>2</td>
<td>No</td>
<td>7826</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Coverage</td>
<td>9134</td>
<td>3</td>
<td>Basic</td>
<td>5568</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Education</td>
<td>9134</td>
<td>5</td>
<td>Bachelor</td>
<td>2748</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Effective To Date</td>
<td>9134</td>
<td>59</td>
<td>1/10/11</td>
<td>195</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">EmploymentStatus</td>
<td>9134</td>
<td>5</td>
<td>Employed</td>
<td>5698</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Gender</td>
<td>9134</td>
<td>2</td>
<td>F</td>
<td>4658</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Income</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>37657.380009</td>
<td>30379.904734</td>
<td>0.0</td>
<td>0.0</td>
<td>33889.5</td>
<td>62320.0</td>
<td>99981.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Location Code</td>
<td>9134</td>
<td>3</td>
<td>Suburban</td>
<td>5779</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Marital Status</td>
<td>9134</td>
<td>3</td>
<td>Married</td>
<td>5298</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Monthly Premium Auto</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>93.219291</td>
<td>34.407967</td>
<td>61.0</td>
<td>68.0</td>
<td>83.0</td>
<td>109.0</td>
<td>298.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Months Since Last Claim</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>15.097</td>
<td>10.073257</td>
<td>0.0</td>
<td>6.0</td>
<td>14.0</td>
<td>23.0</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Months Since Policy Inception</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>48.064594</td>
<td>27.905991</td>
<td>0.0</td>
<td>24.0</td>
<td>48.0</td>
<td>71.0</td>
<td>99.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Number of Open Complaints</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.384388</td>
<td>0.910384</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>5.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Number of Policies</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2.96617</td>
<td>2.390182</td>
<td>1.0</td>
<td>1.0</td>
<td>2.0</td>
<td>4.0</td>
<td>9.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Policy Type</td>
<td>9134</td>
<td>3</td>
<td>Personal Auto</td>
<td>6788</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Policy</td>
<td>9134</td>
<td>9</td>
<td>Personal L3</td>
<td>3426</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Renew Offer Type</td>
<td>9134</td>
<td>4</td>
<td>Offer1</td>
<td>3752</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Sales Channel</td>
<td>9134</td>
<td>4</td>
<td>Agent</td>
<td>3477</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Total Claim Amount</td>
<td>9134.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>434.088794</td>
<td>290.500092</td>
<td>0.099007</td>
<td>272.258244</td>
<td>383.945434</td>
<td>547.514839</td>
<td>2893.239678</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Vehicle Class</td>
<td>9134</td>
<td>6</td>
<td>Four-Door Car</td>
<td>4621</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Vehicle Size</td>
<td>9134</td>
<td>3</td>
<td>Medsize</td>
<td>6424</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>VISUAL EDA</strong></p>
<div id="cell-6" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the aesthetics for the plots</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the correlation matrix</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> data.select_dtypes(include<span class="op">=</span>[<span class="st">'number'</span>]).corr()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the correlation matrix</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, annot<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">'coolwarm'</span>, fmt<span class="op">=</span><span class="st">".2f"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Correlation Matrix"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CLV_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up the figure for multiple plots</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">2</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of Customer Lifetime Value (CLV)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>sns.histplot(data[<span class="st">'Customer Lifetime Value'</span>], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>, <span class="dv">0</span>], kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Distribution of Customer Lifetime Value (CLV)'</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Customer Lifetime Value'</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of Monthly Premium Auto</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>sns.histplot(data[<span class="st">'Monthly Premium Auto'</span>], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>, <span class="dv">1</span>], kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Distribution of Monthly Premium Auto'</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Monthly Premium Auto'</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of Total Claim Amount</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>sns.histplot(data[<span class="st">'Total Claim Amount'</span>], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>, <span class="dv">0</span>], kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Distribution of Total Claim Amount'</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Total Claim Amount'</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of Income</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>sns.histplot(data[data[<span class="st">'Income'</span>] <span class="op">&gt;</span> <span class="dv">0</span>][<span class="st">'Income'</span>], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>, <span class="dv">1</span>], kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'purple'</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Distribution of Income (Excluding Zero Income)'</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Income'</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context('mode.use_inf_as_na', True):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context('mode.use_inf_as_na', True):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context('mode.use_inf_as_na', True):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context('mode.use_inf_as_na', True):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CLV_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up the figure for scatter plots</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">5</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of CLV vs Monthly Premium Auto</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span><span class="st">'Monthly Premium Auto'</span>, y<span class="op">=</span><span class="st">'Customer Lifetime Value'</span>, data<span class="op">=</span>data, ax<span class="op">=</span>axes[<span class="dv">0</span>], alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'CLV vs Monthly Premium Auto'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Monthly Premium Auto'</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Customer Lifetime Value'</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of CLV vs Total Claim Amount</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span><span class="st">'Total Claim Amount'</span>, y<span class="op">=</span><span class="st">'Customer Lifetime Value'</span>, data<span class="op">=</span>data, ax<span class="op">=</span>axes[<span class="dv">1</span>], alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'CLV vs Total Claim Amount'</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Total Claim Amount'</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Customer Lifetime Value'</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of CLV vs Income</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span><span class="st">'Income'</span>, y<span class="op">=</span><span class="st">'Customer Lifetime Value'</span>, data<span class="op">=</span>data, ax<span class="op">=</span>axes[<span class="dv">2</span>], alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_title(<span class="st">'CLV vs Income'</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xlabel(<span class="st">'Income'</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">'Customer Lifetime Value'</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CLV_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Inferential Statistics</strong></p>
<div id="cell-10" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Performing ANOVA tests for each categorical variable</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>anova_results <span class="op">=</span> {}</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>categorical_variables <span class="op">=</span> [<span class="st">'Coverage'</span>, <span class="st">'Education'</span>, <span class="st">'EmploymentStatus'</span>, <span class="st">'Gender'</span>, <span class="st">'Location Code'</span>, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Marital Status'</span>, <span class="st">'Policy Type'</span>, <span class="st">'Renew Offer Type'</span>, <span class="st">'Sales Channel'</span>, </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Vehicle Class'</span>, <span class="st">'Vehicle Size'</span>, <span class="st">'State'</span>, <span class="st">'Policy'</span>]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> var <span class="kw">in</span> categorical_variables:</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    groups <span class="op">=</span> [data[<span class="st">'Customer Lifetime Value'</span>][data[var] <span class="op">==</span> category] <span class="cf">for</span> category <span class="kw">in</span> data[var].unique()]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    F_statistic, p_value <span class="op">=</span> stats.f_oneway(<span class="op">*</span>groups)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    anova_results[var] <span class="op">=</span> {<span class="st">'F-statistic'</span>: F_statistic, <span class="st">'p-value'</span>: p_value}</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>anova_results</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>{'Coverage': {'F-statistic': 133.67511419504905,
  'p-value': 6.0158970099807e-58},
 'Education': {'F-statistic': 2.422865348052191,
  'p-value': 0.04603615409468821},
 'EmploymentStatus': {'F-statistic': 3.8098087103286047,
  'p-value': 0.00425058662383102},
 'Gender': {'F-statistic': 1.6917849875830426, 'p-value': 0.193398656308463},
 'Location Code': {'F-statistic': 0.10800210605345349,
  'p-value': 0.8976268526407198},
 'Marital Status': {'F-statistic': 3.317664937589137,
  'p-value': 0.036281036735873},
 'Policy Type': {'F-statistic': 2.1836446340486555,
  'p-value': 0.11268909882175004},
 'Renew Offer Type': {'F-statistic': 25.832614444940408,
  'p-value': 1.238399930571374e-16},
 'Sales Channel': {'F-statistic': 0.8805454785276249,
  'p-value': 0.4502779502550758},
 'Vehicle Class': {'F-statistic': 267.1581168024349,
  'p-value': 2.085525760212929e-267},
 'Vehicle Size': {'F-statistic': 2.382494601032998,
  'p-value': 0.09237737701331775},
 'State': {'F-statistic': 0.27289285462119306, 'p-value': 0.8955985932127517},
 'Policy': {'F-statistic': 1.1839990669675131, 'p-value': 0.3041951364145143}}</code></pre>
</div>
</div>
<div id="cell-12" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean CLV for different coverage types</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>coverage_mean_clv <span class="op">=</span> data.groupby(<span class="st">'Coverage'</span>)[<span class="st">'Customer Lifetime Value'</span>].mean()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the distribution of CLV for different coverage types</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">'Coverage'</span>, y<span class="op">=</span><span class="st">'Customer Lifetime Value'</span>, data<span class="op">=</span>data)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of CLV by Coverage Type'</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>coverage_mean_clv</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CLV_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>Coverage
Basic        7190.706422
Extended     8789.677608
Premium     10895.603083
Name: Customer Lifetime Value, dtype: float64</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean CLV for different employment statuses</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>employment_status_mean_clv <span class="op">=</span> data.groupby(<span class="st">'EmploymentStatus'</span>)[<span class="st">'Customer Lifetime Value'</span>].mean()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the distribution of CLV for different employment statuses</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">'EmploymentStatus'</span>, y<span class="op">=</span><span class="st">'Customer Lifetime Value'</span>, data<span class="op">=</span>data)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of CLV by Employment Status'</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>employment_status_mean_clv</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CLV_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>EmploymentStatus
Disabled         7847.889354
Employed         8219.117754
Medical Leave    7641.822437
Retired          7487.865141
Unemployed       7636.319761
Name: Customer Lifetime Value, dtype: float64</code></pre>
</div>
</div>
<div id="cell-14" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean CLV for different renew offer types</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>renew_offer_type_mean_clv <span class="op">=</span> data.groupby(<span class="st">'Renew Offer Type'</span>)[<span class="st">'Customer Lifetime Value'</span>].mean()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the distribution of CLV for different renew offer types</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">'Renew Offer Type'</span>, y<span class="op">=</span><span class="st">'Customer Lifetime Value'</span>, data<span class="op">=</span>data)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of CLV by Renew Offer Type'</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>renew_offer_type_mean_clv</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CLV_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Renew Offer Type
Offer1    8707.085583
Offer2    7396.753826
Offer3    7997.886516
Offer4    7179.947270
Name: Customer Lifetime Value, dtype: float64</code></pre>
</div>
</div>
<div id="cell-15" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean CLV for different vehicle classes</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>vehicle_class_mean_clv <span class="op">=</span> data.groupby(<span class="st">'Vehicle Class'</span>)[<span class="st">'Customer Lifetime Value'</span>].mean()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the distribution of CLV for different vehicle classes</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">'Vehicle Class'</span>, y<span class="op">=</span><span class="st">'Customer Lifetime Value'</span>, data<span class="op">=</span>data)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of CLV by Vehicle Class'</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>vehicle_class_mean_clv</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/opt/conda/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="CLV_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Vehicle Class
Four-Door Car     6631.726607
Luxury Car       17053.348399
Luxury SUV       17122.999134
SUV              10443.511816
Sports Car       10750.989331
Two-Door Car      6671.030732
Name: Customer Lifetime Value, dtype: float64</code></pre>
</div>
</div>
<div id="cell-16" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># One-hot encoding of categorical variables</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>data_encoded <span class="op">=</span> pd.get_dummies(data, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying the first few rows of the encoded data</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>data_encoded_head <span class="op">=</span> data_encoded.head()</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>data_encoded_columns <span class="op">=</span> data_encoded.columns</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>data_encoded_head, data_encoded_columns</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>(   Customer Lifetime Value  Income  Monthly Premium Auto  \
 0              2763.519279   56274                    69   
 1              6979.535903       0                    94   
 2             12887.431650   48767                   108   
 3              7645.861827       0                   106   
 4              2813.692575   43836                    73   
 
    Months Since Last Claim  Months Since Policy Inception  \
 0                       32                              5   
 1                       13                             42   
 2                       18                             38   
 3                       18                             65   
 4                       12                             44   
 
    Number of Open Complaints  Number of Policies  Total Claim Amount  \
 0                          0                   1          384.811147   
 1                          0                   8         1131.464935   
 2                          0                   2          566.472247   
 3                          0                   7          529.881344   
 4                          0                   1          138.130879   
 
    Customer_AA11235  Customer_AA16582  ...  Sales Channel_Branch  \
 0             False             False  ...                 False   
 1             False             False  ...                 False   
 2             False             False  ...                 False   
 3             False             False  ...                 False   
 4             False             False  ...                 False   
 
    Sales Channel_Call Center  Sales Channel_Web  Vehicle Class_Luxury Car  \
 0                      False              False                     False   
 1                      False              False                     False   
 2                      False              False                     False   
 3                       True              False                     False   
 4                      False              False                     False   
 
    Vehicle Class_Luxury SUV  Vehicle Class_SUV  Vehicle Class_Sports Car  \
 0                     False              False                     False   
 1                     False              False                     False   
 2                     False              False                     False   
 3                     False               True                     False   
 4                     False              False                     False   
 
    Vehicle Class_Two-Door Car  Vehicle Size_Medsize  Vehicle Size_Small  
 0                        True                  True               False  
 1                       False                  True               False  
 2                        True                  True               False  
 3                       False                  True               False  
 4                       False                  True               False  
 
 [5 rows x 9242 columns],
 Index(['Customer Lifetime Value', 'Income', 'Monthly Premium Auto',
        'Months Since Last Claim', 'Months Since Policy Inception',
        'Number of Open Complaints', 'Number of Policies', 'Total Claim Amount',
        'Customer_AA11235', 'Customer_AA16582',
        ...
        'Sales Channel_Branch', 'Sales Channel_Call Center',
        'Sales Channel_Web', 'Vehicle Class_Luxury Car',
        'Vehicle Class_Luxury SUV', 'Vehicle Class_SUV',
        'Vehicle Class_Sports Car', 'Vehicle Class_Two-Door Car',
        'Vehicle Size_Medsize', 'Vehicle Size_Small'],
       dtype='object', length=9242))</code></pre>
</div>
</div>
<div id="cell-17" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing customer ID related features</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>customer_id_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> data_encoded.columns <span class="cf">if</span> col.startswith(<span class="st">'Customer_'</span>)]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>data_encoded <span class="op">=</span> data_encoded.drop(columns<span class="op">=</span>customer_id_columns)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>date_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> data_encoded.columns <span class="cf">if</span> col.startswith(<span class="st">'Effective To Date'</span>)]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>data_encoded <span class="op">=</span> data_encoded.drop(columns<span class="op">=</span>date_cols)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying the updated number of columns</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>updated_column_count <span class="op">=</span> <span class="bu">len</span>(data_encoded.columns)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>updated_column_count</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>51</code></pre>
</div>
</div>
<div id="cell-18" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>data_encoded</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer Lifetime Value</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Monthly Premium Auto</th>
<th data-quarto-table-cell-role="th">Months Since Last Claim</th>
<th data-quarto-table-cell-role="th">Months Since Policy Inception</th>
<th data-quarto-table-cell-role="th">Number of Open Complaints</th>
<th data-quarto-table-cell-role="th">Number of Policies</th>
<th data-quarto-table-cell-role="th">Total Claim Amount</th>
<th data-quarto-table-cell-role="th">State_California</th>
<th data-quarto-table-cell-role="th">State_Nevada</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Sales Channel_Branch</th>
<th data-quarto-table-cell-role="th">Sales Channel_Call Center</th>
<th data-quarto-table-cell-role="th">Sales Channel_Web</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Sports Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Two-Door Car</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Medsize</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Small</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2763.519279</td>
<td>56274</td>
<td>69</td>
<td>32</td>
<td>5</td>
<td>0</td>
<td>1</td>
<td>384.811147</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>6979.535903</td>
<td>0</td>
<td>94</td>
<td>13</td>
<td>42</td>
<td>0</td>
<td>8</td>
<td>1131.464935</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12887.431650</td>
<td>48767</td>
<td>108</td>
<td>18</td>
<td>38</td>
<td>0</td>
<td>2</td>
<td>566.472247</td>
<td>False</td>
<td>True</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7645.861827</td>
<td>0</td>
<td>106</td>
<td>18</td>
<td>65</td>
<td>0</td>
<td>7</td>
<td>529.881344</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2813.692575</td>
<td>43836</td>
<td>73</td>
<td>12</td>
<td>44</td>
<td>0</td>
<td>1</td>
<td>138.130879</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9129</td>
<td>23405.987980</td>
<td>71941</td>
<td>73</td>
<td>18</td>
<td>89</td>
<td>0</td>
<td>2</td>
<td>198.234764</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9130</td>
<td>3096.511217</td>
<td>21604</td>
<td>79</td>
<td>14</td>
<td>28</td>
<td>0</td>
<td>1</td>
<td>379.200000</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9131</td>
<td>8163.890428</td>
<td>0</td>
<td>85</td>
<td>9</td>
<td>37</td>
<td>3</td>
<td>2</td>
<td>790.784983</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9132</td>
<td>7524.442436</td>
<td>21941</td>
<td>96</td>
<td>34</td>
<td>3</td>
<td>0</td>
<td>3</td>
<td>691.200000</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9133</td>
<td>2611.836866</td>
<td>0</td>
<td>77</td>
<td>3</td>
<td>90</td>
<td>0</td>
<td>1</td>
<td>369.600000</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>9134 rows  51 columns</p>
</div>
</div>
</div>
<div id="cell-19" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating interaction features between Income and Coverage</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> coverage_type <span class="kw">in</span> [<span class="st">'Coverage_Extended'</span>, <span class="st">'Coverage_Premium'</span>]:</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    interaction_feature_name <span class="op">=</span> <span class="ss">f'Income_</span><span class="sc">{</span>coverage_type<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    data_encoded[interaction_feature_name] <span class="op">=</span> data_encoded[<span class="st">'Income'</span>] <span class="op">*</span> data_encoded[coverage_type]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying the first few rows of the updated dataset</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>data_encoded[[<span class="st">'Income'</span>, <span class="st">'Coverage_Extended'</span>, <span class="st">'Coverage_Premium'</span>, <span class="st">'Income_Coverage_Extended'</span>, <span class="st">'Income_Coverage_Premium'</span>]].head()</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Coverage_Extended</th>
<th data-quarto-table-cell-role="th">Coverage_Premium</th>
<th data-quarto-table-cell-role="th">Income_Coverage_Extended</th>
<th data-quarto-table-cell-role="th">Income_Coverage_Premium</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>56274</td>
<td>False</td>
<td>False</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>True</td>
<td>False</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>48767</td>
<td>False</td>
<td>True</td>
<td>0</td>
<td>48767</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>False</td>
<td>False</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>43836</td>
<td>False</td>
<td>False</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the features (X) and the target variable (y)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> data_encoded.drop(<span class="st">'Customer Lifetime Value'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> data_encoded[<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the dataset into training and testing sets</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a Random Forest model</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>rf.fit(X_train, y_train)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting feature importances</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>feature_importances <span class="op">=</span> rf.feature_importances_</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> X.columns</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a DataFrame for feature importances</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>feature_importance_df <span class="op">=</span> pd.DataFrame({<span class="st">'Feature'</span>: feature_names, <span class="st">'Importance'</span>: feature_importances})</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>feature_importance_df <span class="op">=</span> feature_importance_df.sort_values(by<span class="op">=</span><span class="st">'Importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying the top 20 most important features</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>top_20_features <span class="op">=</span> feature_importance_df.head(<span class="dv">20</span>)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>top_20_features</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Feature</th>
<th data-quarto-table-cell-role="th">Importance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>Number of Policies</td>
<td>0.466433</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Monthly Premium Auto</td>
<td>0.253064</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Months Since Last Claim</td>
<td>0.043022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>Total Claim Amount</td>
<td>0.037320</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>Months Since Policy Inception</td>
<td>0.035491</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>Income</td>
<td>0.027280</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50</td>
<td>Income_Coverage_Extended</td>
<td>0.011561</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16</td>
<td>Education_High School or Below</td>
<td>0.005807</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Number of Open Complaints</td>
<td>0.005530</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">40</td>
<td>Sales Channel_Branch</td>
<td>0.005120</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>Gender_M</td>
<td>0.004979</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>Renew Offer Type_Offer2</td>
<td>0.004785</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>Location Code_Urban</td>
<td>0.004395</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>Marital Status_Married</td>
<td>0.004184</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Education_College</td>
<td>0.004168</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Response_Yes</td>
<td>0.004063</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">48</td>
<td>Vehicle Size_Medsize</td>
<td>0.003873</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">32</td>
<td>Policy_Personal L2</td>
<td>0.003830</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>Sales Channel_Web</td>
<td>0.003735</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>Education_Master</td>
<td>0.003654</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> RFECV</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating cumulative feature importance</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>feature_importance_df[<span class="st">'Cumulative Importance'</span>] <span class="op">=</span> top_20_features[<span class="st">'Importance'</span>].cumsum()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Determining the features to keep based on a 95% cumulative importance threshold</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>features_to_keep <span class="op">=</span> feature_importance_df[feature_importance_df[<span class="st">'Cumulative Importance'</span>] <span class="op">&lt;=</span> threshold]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of features to keep</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>number_of_features_to_keep <span class="op">=</span> features_to_keep.shape[<span class="dv">0</span>]</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Selected features based on the threshold</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>selected_features_threshold <span class="op">=</span> features_to_keep[<span class="st">'Feature'</span>]</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>number_of_features_to_keep, selected_features_threshold</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(20,
 5                 Number of Policies
 1               Monthly Premium Auto
 2            Months Since Last Claim
 6                 Total Claim Amount
 3      Months Since Policy Inception
 0                             Income
 50          Income_Coverage_Extended
 16    Education_High School or Below
 4          Number of Open Complaints
 40              Sales Channel_Branch
 22                          Gender_M
 37           Renew Offer Type_Offer2
 24               Location Code_Urban
 25            Marital Status_Married
 14                 Education_College
 11                      Response_Yes
 48              Vehicle Size_Medsize
 32                Policy_Personal L2
 42                 Sales Channel_Web
 17                  Education_Master
 Name: Feature, dtype: object)</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error, mean_squared_error, r2_score</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_and_evaluate_linear(data, columns, model_name):</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the DataFrame and columns list are not empty</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data.empty <span class="kw">or</span> <span class="kw">not</span> columns:</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {model_name: {<span class="st">'Error'</span>: <span class="st">'Empty DataFrame or Columns'</span>}}</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select specified columns and handle missing values</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    data_selected <span class="op">=</span> data[columns].dropna()</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split into features and target</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Customer Lifetime Value'</span> <span class="kw">not</span> <span class="kw">in</span> data_selected:</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {model_name: {<span class="st">'Error'</span>: <span class="st">'Target column missing'</span>}}</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> data_selected.drop(<span class="st">'Customer Lifetime Value'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> data_selected[<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if X is empty after dropping NaN values</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> X.empty:</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {model_name: {<span class="st">'Error'</span>: <span class="st">'No data to train on after handling NaN values'</span>}}</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select specified columns</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    data_selected <span class="op">=</span> data[columns]</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split into features and target</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> data_selected.drop(<span class="st">'Customer Lifetime Value'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> data_selected[<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split data into training and testing sets</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize the features</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    X_train_scaled <span class="op">=</span> scaler.fit_transform(X_train)</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    X_test_scaled <span class="op">=</span> scaler.transform(X_test)</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the model</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LinearRegression()</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train_scaled, y_train)</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions and evaluate the model</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> model.predict(X_test_scaled)</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(y_test, y_pred)</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> mean_squared_error(y_test, y_pred)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(y_test, y_pred)</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the performance metrics</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>        model_name: {</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">'MAE'</span>: mae,</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">'MSE'</span>: mse,</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">'R2'</span>: r2</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error, mean_squared_error, r2_score</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> [<span class="st">'Number of Policies'</span>, <span class="st">'Monthly Premium Auto'</span>, <span class="st">'Months Since Last Claim'</span>, <span class="st">'Total Claim Amount'</span>, <span class="st">'Months Since Policy Inception'</span>, <span class="st">'Income'</span>, <span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary to store results</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>all_results <span class="op">=</span> {}</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate all combinations of columns</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(columns) <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subset <span class="kw">in</span> itertools.combinations(columns, r):</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        updated_columns <span class="op">=</span> <span class="bu">list</span>(subset) <span class="op">+</span> [<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        model_name <span class="op">=</span> <span class="ss">f'model_</span><span class="sc">{</span><span class="st">"_"</span><span class="sc">.</span>join(subset)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> train_and_evaluate_linear(data_encoded, updated_columns, model_name)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        all_results[model_name] <span class="op">=</span> results</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>formatted_results <span class="op">=</span> []</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, metrics <span class="kw">in</span> all_results.items():</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    formatted_result <span class="op">=</span> {<span class="st">'Model'</span>: model_name}</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    formatted_result.update(metrics[model_name])  <span class="co"># This assumes metrics are stored under the model name</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    formatted_results.append(formatted_result)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the formatted list of dictionaries to a DataFrame</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame(formatted_results)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>linear_model <span class="op">=</span> results_df.sort_values(by<span class="op">=</span><span class="st">'MAE'</span>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>linear_model.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Model</th>
<th data-quarto-table-cell-role="th">MAE</th>
<th data-quarto-table-cell-role="th">MSE</th>
<th data-quarto-table-cell-role="th">R2</th>
<th data-quarto-table-cell-role="th">Error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>model_Monthly Premium Auto_Total Claim Amount</td>
<td>3983.106027</td>
<td>4.373129e+07</td>
<td>0.151444</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49</td>
<td>model_Monthly Premium Auto_Total Claim Amount_...</td>
<td>3983.106027</td>
<td>4.373129e+07</td>
<td>0.151444</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">47</td>
<td>model_Monthly Premium Auto_Total Claim Amount_...</td>
<td>3983.917983</td>
<td>4.374930e+07</td>
<td>0.151095</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">90</td>
<td>model_Monthly Premium Auto_Total Claim Amount_...</td>
<td>3983.917983</td>
<td>4.374930e+07</td>
<td>0.151095</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">85</td>
<td>model_Monthly Premium Auto_Months Since Last C...</td>
<td>3984.466308</td>
<td>4.372443e+07</td>
<td>0.151577</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>model_Monthly Premium Auto_Months Since Last C...</td>
<td>3984.466308</td>
<td>4.372443e+07</td>
<td>0.151577</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>model_Monthly Premium Auto</td>
<td>3984.908237</td>
<td>4.383850e+07</td>
<td>0.149364</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>model_Monthly Premium Auto_Customer Lifetime V...</td>
<td>3984.908237</td>
<td>4.383850e+07</td>
<td>0.149364</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">83</td>
<td>model_Monthly Premium Auto_Months Since Last C...</td>
<td>3985.380477</td>
<td>4.374338e+07</td>
<td>0.151210</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">114</td>
<td>model_Monthly Premium Auto_Months Since Last C...</td>
<td>3985.380477</td>
<td>4.374338e+07</td>
<td>0.151210</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>linear_model.to_csv(<span class="st">'modelmeasure.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error, mean_squared_error, r2_score</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_and_evaluate_random_forest(data, columns, model_name):</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the DataFrame and columns list are not empty</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data.empty <span class="kw">or</span> <span class="kw">not</span> columns:</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {model_name: {<span class="st">'Error'</span>: <span class="st">'Empty DataFrame or Columns'</span>}}</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select specified columns and handle missing values</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    data_selected <span class="op">=</span> data[columns].dropna()</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split into features and target</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Customer Lifetime Value'</span> <span class="kw">not</span> <span class="kw">in</span> data_selected:</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {model_name: {<span class="st">'Error'</span>: <span class="st">'Target column missing'</span>}}</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> data_selected.drop(<span class="st">'Customer Lifetime Value'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> data_selected[<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if X is empty after dropping NaN values</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> X.empty:</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {model_name: {<span class="st">'Error'</span>: <span class="st">'No data to train on after handling NaN values'</span>}}</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split data into training and testing sets</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize the features</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    X_train_scaled <span class="op">=</span> scaler.fit_transform(X_train)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    X_test_scaled <span class="op">=</span> scaler.transform(X_test)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the Random Forest model</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train_scaled, y_train)</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions and evaluate the model</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> model.predict(X_test_scaled)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(y_test, y_pred)</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> mean_squared_error(y_test, y_pred)</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(y_test, y_pred)</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the performance metrics</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>        model_name: {</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'MAE'</span>: mae,</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'MSE'</span>: mse,</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'R2'</span>: r2</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error, mean_squared_error, r2_score</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming train_and_evaluate_random_forest function is defined as shown before</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> [<span class="st">'Number of Policies'</span>, <span class="st">'Monthly Premium Auto'</span>, <span class="st">'Months Since Last Claim'</span>, <span class="st">'Total Claim Amount'</span>, <span class="st">'Months Since Policy Inception'</span>, <span class="st">'Income'</span>, <span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary to store results</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>all_results <span class="op">=</span> {}</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate all combinations of columns</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">4</span>):</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subset <span class="kw">in</span> itertools.combinations(columns, r):</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        updated_columns <span class="op">=</span> <span class="bu">list</span>(subset) <span class="op">+</span> [<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        model_name <span class="op">=</span> <span class="ss">f'model_</span><span class="sc">{</span><span class="st">"_"</span><span class="sc">.</span>join(subset)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> train_and_evaluate_random_forest(data_encoded, updated_columns, model_name)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        all_results[model_name] <span class="op">=</span> results</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>formatted_results <span class="op">=</span> []</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, metrics <span class="kw">in</span> all_results.items():</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    formatted_result <span class="op">=</span> {<span class="st">'Model'</span>: model_name}</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    formatted_result.update(metrics[model_name])  <span class="co"># This assumes metrics are stored under the model name</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    formatted_results.append(formatted_result)</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the formatted list of dictionaries to a DataFrame</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame(formatted_results)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>random_forest_model <span class="op">=</span> results_df.sort_values(by<span class="op">=</span><span class="st">'MAE'</span>)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>random_forest_model.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Model</th>
<th data-quarto-table-cell-role="th">MAE</th>
<th data-quarto-table-cell-role="th">MSE</th>
<th data-quarto-table-cell-role="th">R2</th>
<th data-quarto-table-cell-role="th">Error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">31</td>
<td>model_Number of Policies_Monthly Premium Auto_...</td>
<td>1529.112874</td>
<td>1.849684e+07</td>
<td>0.641090</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>model_Number of Policies_Monthly Premium Auto_...</td>
<td>1636.994069</td>
<td>1.901234e+07</td>
<td>0.631087</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>model_Number of Policies_Monthly Premium Auto_...</td>
<td>1639.742293</td>
<td>1.933793e+07</td>
<td>0.624770</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28</td>
<td>model_Number of Policies_Monthly Premium Auto_...</td>
<td>1684.131026</td>
<td>1.973733e+07</td>
<td>0.617020</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>model_Number of Policies_Monthly Premium Auto_...</td>
<td>1759.569174</td>
<td>1.871778e+07</td>
<td>0.636803</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>model_Number of Policies_Monthly Premium Auto</td>
<td>1759.613625</td>
<td>1.871781e+07</td>
<td>0.636802</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>model_Number of Policies_Total Claim Amount_In...</td>
<td>2216.355388</td>
<td>2.351015e+07</td>
<td>0.543812</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>model_Number of Policies_Total Claim Amount_Mo...</td>
<td>2318.382429</td>
<td>2.535516e+07</td>
<td>0.508012</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33</td>
<td>model_Number of Policies_Months Since Last Cla...</td>
<td>2321.335992</td>
<td>2.694544e+07</td>
<td>0.477154</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39</td>
<td>model_Number of Policies_Total Claim Amount_Cu...</td>
<td>2538.499378</td>
<td>3.020798e+07</td>
<td>0.413849</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>random_forest_model.to_csv(<span class="st">'random_forest_model.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-29" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>extended_dataset<span class="op">=</span>pd.read_csv(<span class="st">'extended_dataset.csv'</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>extended_dataset.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer</th>
<th data-quarto-table-cell-role="th">State</th>
<th data-quarto-table-cell-role="th">Customer Lifetime Value</th>
<th data-quarto-table-cell-role="th">Response</th>
<th data-quarto-table-cell-role="th">Coverage</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">Effective To Date</th>
<th data-quarto-table-cell-role="th">EmploymentStatus</th>
<th data-quarto-table-cell-role="th">Gender</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Months Since Policy Inception</th>
<th data-quarto-table-cell-role="th">Number of Open Complaints</th>
<th data-quarto-table-cell-role="th">Number of Policies</th>
<th data-quarto-table-cell-role="th">Policy Type</th>
<th data-quarto-table-cell-role="th">Policy</th>
<th data-quarto-table-cell-role="th">Renew Offer Type</th>
<th data-quarto-table-cell-role="th">Sales Channel</th>
<th data-quarto-table-cell-role="th">Total Claim Amount</th>
<th data-quarto-table-cell-role="th">Vehicle Class</th>
<th data-quarto-table-cell-role="th">Vehicle Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>BU79786</td>
<td>Washington</td>
<td>2763.519279</td>
<td>No</td>
<td>Basic</td>
<td>Bachelor</td>
<td>2/24/2011</td>
<td>Employed</td>
<td>F</td>
<td>56274</td>
<td>...</td>
<td>5</td>
<td>0</td>
<td>1</td>
<td>Corporate Auto</td>
<td>Corporate L3</td>
<td>Offer1</td>
<td>Agent</td>
<td>384.811147</td>
<td>Two-Door Car</td>
<td>Medsize</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>QZ44356</td>
<td>Arizona</td>
<td>6979.535903</td>
<td>No</td>
<td>Extended</td>
<td>Bachelor</td>
<td>1/31/2011</td>
<td>Unemployed</td>
<td>F</td>
<td>0</td>
<td>...</td>
<td>42</td>
<td>0</td>
<td>8</td>
<td>Personal Auto</td>
<td>Personal L3</td>
<td>Offer3</td>
<td>Agent</td>
<td>1131.464935</td>
<td>Four-Door Car</td>
<td>Medsize</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AI49188</td>
<td>Nevada</td>
<td>12887.431650</td>
<td>No</td>
<td>Premium</td>
<td>Bachelor</td>
<td>2/19/2011</td>
<td>Employed</td>
<td>F</td>
<td>48767</td>
<td>...</td>
<td>38</td>
<td>0</td>
<td>2</td>
<td>Personal Auto</td>
<td>Personal L3</td>
<td>Offer1</td>
<td>Agent</td>
<td>566.472247</td>
<td>Two-Door Car</td>
<td>Medsize</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>WW63253</td>
<td>California</td>
<td>7645.861827</td>
<td>No</td>
<td>Basic</td>
<td>Bachelor</td>
<td>1/20/2011</td>
<td>Unemployed</td>
<td>M</td>
<td>0</td>
<td>...</td>
<td>65</td>
<td>0</td>
<td>7</td>
<td>Corporate Auto</td>
<td>Corporate L2</td>
<td>Offer1</td>
<td>Call Center</td>
<td>529.881344</td>
<td>SUV</td>
<td>Medsize</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>HB64268</td>
<td>Washington</td>
<td>2813.692575</td>
<td>No</td>
<td>Basic</td>
<td>Bachelor</td>
<td>2/3/2011</td>
<td>Employed</td>
<td>M</td>
<td>43836</td>
<td>...</td>
<td>44</td>
<td>0</td>
<td>1</td>
<td>Personal Auto</td>
<td>Personal L1</td>
<td>Offer1</td>
<td>Agent</td>
<td>138.130879</td>
<td>Four-Door Car</td>
<td>Medsize</td>
</tr>
</tbody>
</table>

<p>5 rows  24 columns</p>
</div>
</div>
</div>
<div id="cell-30" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>extended_dataset <span class="op">=</span> extended_dataset.drop([<span class="st">'Customer'</span>, <span class="st">'Effective To Date'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>last100rows<span class="op">=</span>extended_dataset.iloc[<span class="op">-</span><span class="dv">100</span>:]</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>last100rows.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">State</th>
<th data-quarto-table-cell-role="th">Customer Lifetime Value</th>
<th data-quarto-table-cell-role="th">Response</th>
<th data-quarto-table-cell-role="th">Coverage</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">EmploymentStatus</th>
<th data-quarto-table-cell-role="th">Gender</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Location Code</th>
<th data-quarto-table-cell-role="th">Marital Status</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Months Since Policy Inception</th>
<th data-quarto-table-cell-role="th">Number of Open Complaints</th>
<th data-quarto-table-cell-role="th">Number of Policies</th>
<th data-quarto-table-cell-role="th">Policy Type</th>
<th data-quarto-table-cell-role="th">Policy</th>
<th data-quarto-table-cell-role="th">Renew Offer Type</th>
<th data-quarto-table-cell-role="th">Sales Channel</th>
<th data-quarto-table-cell-role="th">Total Claim Amount</th>
<th data-quarto-table-cell-role="th">Vehicle Class</th>
<th data-quarto-table-cell-role="th">Vehicle Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">9134</td>
<td>Arizona</td>
<td>NaN</td>
<td>No</td>
<td>Extended</td>
<td>Doctor</td>
<td>Medical Leave</td>
<td>F</td>
<td>75180</td>
<td>Rural</td>
<td>Single</td>
<td>...</td>
<td>66</td>
<td>3</td>
<td>5</td>
<td>Special Auto</td>
<td>Personal L1</td>
<td>Offer3</td>
<td>Web</td>
<td>2751.07159</td>
<td>Sports Car</td>
<td>Small</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9135</td>
<td>Oregon</td>
<td>NaN</td>
<td>Yes</td>
<td>Extended</td>
<td>High School or Below</td>
<td>Retired</td>
<td>M</td>
<td>93139</td>
<td>Suburban</td>
<td>Married</td>
<td>...</td>
<td>55</td>
<td>3</td>
<td>8</td>
<td>Corporate Auto</td>
<td>Special L2</td>
<td>Offer4</td>
<td>Call Center</td>
<td>6397.29927</td>
<td>Luxury SUV</td>
<td>Small</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9136</td>
<td>Washington</td>
<td>NaN</td>
<td>No</td>
<td>Extended</td>
<td>High School or Below</td>
<td>Disabled</td>
<td>M</td>
<td>79100</td>
<td>Rural</td>
<td>Married</td>
<td>...</td>
<td>19</td>
<td>0</td>
<td>1</td>
<td>Special Auto</td>
<td>Personal L2</td>
<td>Offer2</td>
<td>Agent</td>
<td>811.08075</td>
<td>Four-Door Car</td>
<td>Large</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9137</td>
<td>Arizona</td>
<td>NaN</td>
<td>Yes</td>
<td>Premium</td>
<td>Master</td>
<td>Medical Leave</td>
<td>F</td>
<td>2757</td>
<td>Urban</td>
<td>Single</td>
<td>...</td>
<td>85</td>
<td>0</td>
<td>2</td>
<td>Personal Auto</td>
<td>Special L2</td>
<td>Offer2</td>
<td>Branch</td>
<td>2293.22335</td>
<td>Sports Car</td>
<td>Large</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9138</td>
<td>Arizona</td>
<td>NaN</td>
<td>Yes</td>
<td>Premium</td>
<td>Doctor</td>
<td>Unemployed</td>
<td>F</td>
<td>37798</td>
<td>Urban</td>
<td>Married</td>
<td>...</td>
<td>38</td>
<td>4</td>
<td>3</td>
<td>Special Auto</td>
<td>Corporate L1</td>
<td>Offer1</td>
<td>Call Center</td>
<td>1885.78180</td>
<td>Two-Door Car</td>
<td>Small</td>
</tr>
</tbody>
</table>

<p>5 rows  22 columns</p>
</div>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># One-hot encoding of categorical variables</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_1 <span class="op">=</span> pd.get_dummies(extended_dataset, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_2 <span class="op">=</span> pd.get_dummies(extended_dataset, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_3 <span class="op">=</span> pd.get_dummies(extended_dataset, drop_first<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="final-model---1" class="level3">
<h3 class="anchored" data-anchor-id="final-model---1">Final Model - 1</h3>
<div id="cell-34" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># X = extended_dataset_encoded.drop('Customer Lifetime Value', axis=1)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># y = extended_dataset_encoded['Customer Lifetime Value']</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell" data-editable="true" data-slideshow="{&quot;slide_type&quot;:&quot;&quot;}" data-tags="[]" data-execution_count="31">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting only specific columns for the training and prediction datasets</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>selected_columns <span class="op">=</span> [<span class="st">'Number of Policies'</span>, <span class="st">'Monthly Premium Auto'</span>, <span class="st">'Income'</span>, <span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_1[<span class="st">'Customer Lifetime Value'</span>] <span class="op">=</span> extended_dataset_encoded_1[<span class="st">'Customer Lifetime Value'</span>].mask(np.random.rand(<span class="bu">len</span>(extended_dataset_encoded_1)) <span class="op">&lt;</span> <span class="fl">0.1</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># For the training data, include 'Customer Lifetime Value' since it's not null</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> extended_dataset_encoded_1[extended_dataset_encoded_1[<span class="st">'Customer Lifetime Value'</span>].notnull()][selected_columns]</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># For the prediction data, 'Customer Lifetime Value' is null</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>predict_df <span class="op">=</span> extended_dataset_encoded_1[extended_dataset_encoded_1[<span class="st">'Customer Lifetime Value'</span>].isnull()][selected_columns]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-36" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separating features and target for the training set</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> train_df.drop([<span class="st">'Customer Lifetime Value'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> train_df[<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Features for the prediction set</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>X_predict <span class="op">=</span> predict_df.drop([<span class="st">'Customer Lifetime Value'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the training data into new training and test sets</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>X_train_new, X_test, y_train_new, y_test <span class="op">=</span> train_test_split(X_train, y_train, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the Random Forest Regressor model</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>rf_model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model on the new training data</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>rf_model.fit(X_train_new, y_train_new)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicting the CLV for the test set</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> rf_model.predict(X_test)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating MAE, MSE, and R2</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, y_pred)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>mse <span class="op">=</span> mean_squared_error(y_test, y_pred)</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(y_test, y_pred)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean Absolute Error:"</span>, mae)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean Squared Error:"</span>, mse)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R2 Score:"</span>, r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Absolute Error: 1633.9612371099192
Mean Squared Error: 20337535.483674027
R2 Score: 0.5688865707663808</code></pre>
</div>
</div>
<div id="cell-37" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>predicted_clv <span class="op">=</span> rf_model.predict(X_predict)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Assigning the predicted values back to the original dataframe</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_1.loc[extended_dataset_encoded_1[<span class="st">'Customer Lifetime Value'</span>].isnull(), <span class="st">'Customer Lifetime Value'</span>] <span class="op">=</span> predicted_clv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-38" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer Lifetime Value</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Monthly Premium Auto</th>
<th data-quarto-table-cell-role="th">Months Since Last Claim</th>
<th data-quarto-table-cell-role="th">Months Since Policy Inception</th>
<th data-quarto-table-cell-role="th">Number of Open Complaints</th>
<th data-quarto-table-cell-role="th">Number of Policies</th>
<th data-quarto-table-cell-role="th">Total Claim Amount</th>
<th data-quarto-table-cell-role="th">State_California</th>
<th data-quarto-table-cell-role="th">State_Nevada</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Sales Channel_Branch</th>
<th data-quarto-table-cell-role="th">Sales Channel_Call Center</th>
<th data-quarto-table-cell-role="th">Sales Channel_Web</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Sports Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Two-Door Car</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Medsize</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Small</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2763.519279</td>
<td>56274</td>
<td>69</td>
<td>32</td>
<td>5</td>
<td>0</td>
<td>1</td>
<td>384.811147</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>6437.193942</td>
<td>0</td>
<td>94</td>
<td>13</td>
<td>42</td>
<td>0</td>
<td>8</td>
<td>1131.464935</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12887.431650</td>
<td>48767</td>
<td>108</td>
<td>18</td>
<td>38</td>
<td>0</td>
<td>2</td>
<td>566.472247</td>
<td>False</td>
<td>True</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7645.861827</td>
<td>0</td>
<td>106</td>
<td>18</td>
<td>65</td>
<td>0</td>
<td>7</td>
<td>529.881344</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2813.692575</td>
<td>43836</td>
<td>73</td>
<td>12</td>
<td>44</td>
<td>0</td>
<td>1</td>
<td>138.130879</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9229</td>
<td>14691.152451</td>
<td>88811</td>
<td>189</td>
<td>28</td>
<td>82</td>
<td>1</td>
<td>5</td>
<td>477.453270</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9230</td>
<td>6495.149945</td>
<td>60118</td>
<td>83</td>
<td>29</td>
<td>58</td>
<td>4</td>
<td>5</td>
<td>9013.022660</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9231</td>
<td>6777.351696</td>
<td>40867</td>
<td>88</td>
<td>11</td>
<td>63</td>
<td>3</td>
<td>8</td>
<td>1653.198370</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9232</td>
<td>5896.299446</td>
<td>6668</td>
<td>79</td>
<td>30</td>
<td>55</td>
<td>1</td>
<td>8</td>
<td>3569.974780</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9233</td>
<td>18654.742818</td>
<td>31278</td>
<td>260</td>
<td>32</td>
<td>6</td>
<td>2</td>
<td>8</td>
<td>118.834310</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>9234 rows  51 columns</p>
</div>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extended_dataset_encoded_1.to_csv('final_model_1.csv', index=False)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="final-model---2" class="level2">
<h2 class="anchored" data-anchor-id="final-model---2">Final Model - 2</h2>
<div id="cell-41" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting only specific columns for the training and prediction datasets</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>selected_columns <span class="op">=</span> [<span class="st">'Number of Policies'</span>, <span class="st">'Monthly Premium Auto'</span>, <span class="st">'Total Claim Amount'</span>, <span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For the training data, include 'Customer Lifetime Value' since it's not null</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> extended_dataset_encoded_2[extended_dataset_encoded_2[<span class="st">'Customer Lifetime Value'</span>].notnull()][selected_columns]</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For the prediction data, 'Customer Lifetime Value' is null</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>predict_df <span class="op">=</span> extended_dataset_encoded_2[extended_dataset_encoded_2[<span class="st">'Customer Lifetime Value'</span>].isnull()][selected_columns]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separating features and target for the training set</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> train_df.drop([<span class="st">'Customer Lifetime Value'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> train_df[<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Features for the prediction set</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>X_predict <span class="op">=</span> predict_df.drop([<span class="st">'Customer Lifetime Value'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the training data into new training and test sets</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>X_train_new, X_test, y_train_new, y_test <span class="op">=</span> train_test_split(X_train, y_train, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the Random Forest Regressor model</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>rf_model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model on the new training data</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>rf_model.fit(X_train_new, y_train_new)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicting the CLV for the test set</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> rf_model.predict(X_test)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating MAE, MSE, and R2</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, y_pred)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>mse <span class="op">=</span> mean_squared_error(y_test, y_pred)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(y_test, y_pred)</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean Absolute Error:"</span>, mae)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean Squared Error:"</span>, mse)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R2 Score:"</span>, r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Absolute Error: 1637.663036715096
Mean Squared Error: 19021968.80288521
R2 Score: 0.6309004364119323</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>predicted_clv <span class="op">=</span> rf_model.predict(X_predict)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Assigning the predicted values back to the original dataframe</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_2.loc[extended_dataset_encoded_2[<span class="st">'Customer Lifetime Value'</span>].isnull(), <span class="st">'Customer Lifetime Value'</span>] <span class="op">=</span> predicted_clv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(predicted_clv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>100</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer Lifetime Value</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Monthly Premium Auto</th>
<th data-quarto-table-cell-role="th">Months Since Last Claim</th>
<th data-quarto-table-cell-role="th">Months Since Policy Inception</th>
<th data-quarto-table-cell-role="th">Number of Open Complaints</th>
<th data-quarto-table-cell-role="th">Number of Policies</th>
<th data-quarto-table-cell-role="th">Total Claim Amount</th>
<th data-quarto-table-cell-role="th">State_California</th>
<th data-quarto-table-cell-role="th">State_Nevada</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Sales Channel_Branch</th>
<th data-quarto-table-cell-role="th">Sales Channel_Call Center</th>
<th data-quarto-table-cell-role="th">Sales Channel_Web</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Sports Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Two-Door Car</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Medsize</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Small</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2763.519279</td>
<td>56274</td>
<td>69</td>
<td>32</td>
<td>5</td>
<td>0</td>
<td>1</td>
<td>384.811147</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>6979.535903</td>
<td>0</td>
<td>94</td>
<td>13</td>
<td>42</td>
<td>0</td>
<td>8</td>
<td>1131.464935</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12887.431650</td>
<td>48767</td>
<td>108</td>
<td>18</td>
<td>38</td>
<td>0</td>
<td>2</td>
<td>566.472247</td>
<td>False</td>
<td>True</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7645.861827</td>
<td>0</td>
<td>106</td>
<td>18</td>
<td>65</td>
<td>0</td>
<td>7</td>
<td>529.881344</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2813.692575</td>
<td>43836</td>
<td>73</td>
<td>12</td>
<td>44</td>
<td>0</td>
<td>1</td>
<td>138.130879</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9229</td>
<td>14905.808578</td>
<td>88811</td>
<td>189</td>
<td>28</td>
<td>82</td>
<td>1</td>
<td>5</td>
<td>477.453270</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9230</td>
<td>5872.421942</td>
<td>60118</td>
<td>83</td>
<td>29</td>
<td>58</td>
<td>4</td>
<td>5</td>
<td>9013.022660</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9231</td>
<td>6368.989624</td>
<td>40867</td>
<td>88</td>
<td>11</td>
<td>63</td>
<td>3</td>
<td>8</td>
<td>1653.198370</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9232</td>
<td>5849.856621</td>
<td>6668</td>
<td>79</td>
<td>30</td>
<td>55</td>
<td>1</td>
<td>8</td>
<td>3569.974780</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9233</td>
<td>16989.193561</td>
<td>31278</td>
<td>260</td>
<td>32</td>
<td>6</td>
<td>2</td>
<td>8</td>
<td>118.834310</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>9234 rows  51 columns</p>
</div>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extended_dataset_encoded_2.to_csv('final_model_2.csv', index=False)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="final-model---3" class="level2">
<h2 class="anchored" data-anchor-id="final-model---3">Final Model - 3</h2>
<div id="cell-48" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting only specific columns for the training and prediction datasets</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>selected_columns <span class="op">=</span> [<span class="st">'Number of Policies'</span>, <span class="st">'Monthly Premium Auto'</span>, <span class="st">'Months Since Policy Inception'</span>, <span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For the training data, include 'Customer Lifetime Value' since it's not null</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> extended_dataset_encoded_3[extended_dataset_encoded_3[<span class="st">'Customer Lifetime Value'</span>].notnull()][selected_columns]</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For the prediction data, 'Customer Lifetime Value' is null</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>predict_df <span class="op">=</span> extended_dataset_encoded_3[extended_dataset_encoded_3[<span class="st">'Customer Lifetime Value'</span>].isnull()][selected_columns]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-49" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separating features and target for the training set</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> train_df.drop([<span class="st">'Customer Lifetime Value'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> train_df[<span class="st">'Customer Lifetime Value'</span>]</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Features for the prediction set</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>X_predict <span class="op">=</span> predict_df.drop([<span class="st">'Customer Lifetime Value'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the training data into new training and test sets</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>X_train_new, X_test, y_train_new, y_test <span class="op">=</span> train_test_split(X_train, y_train, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the Random Forest Regressor model</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>rf_model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model on the new training data</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>rf_model.fit(X_train_new, y_train_new)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicting the CLV for the test set</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> rf_model.predict(X_test)</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating MAE, MSE, and R2</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, y_pred)</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>mse <span class="op">=</span> mean_squared_error(y_test, y_pred)</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(y_test, y_pred)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean Absolute Error:"</span>, mae)</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean Squared Error:"</span>, mse)</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R2 Score:"</span>, r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Absolute Error: 1634.7015048999385
Mean Squared Error: 19241137.243726563
R2 Score: 0.6266477233145082</code></pre>
</div>
</div>
<div id="cell-50" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>predicted_clv <span class="op">=</span> rf_model.predict(X_predict)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Assigning the predicted values back to the original dataframe</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_3.loc[extended_dataset_encoded_3[<span class="st">'Customer Lifetime Value'</span>].isnull(), <span class="st">'Customer Lifetime Value'</span>] <span class="op">=</span> predicted_clv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>extended_dataset_encoded_3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer Lifetime Value</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Monthly Premium Auto</th>
<th data-quarto-table-cell-role="th">Months Since Last Claim</th>
<th data-quarto-table-cell-role="th">Months Since Policy Inception</th>
<th data-quarto-table-cell-role="th">Number of Open Complaints</th>
<th data-quarto-table-cell-role="th">Number of Policies</th>
<th data-quarto-table-cell-role="th">Total Claim Amount</th>
<th data-quarto-table-cell-role="th">State_California</th>
<th data-quarto-table-cell-role="th">State_Nevada</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Sales Channel_Branch</th>
<th data-quarto-table-cell-role="th">Sales Channel_Call Center</th>
<th data-quarto-table-cell-role="th">Sales Channel_Web</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Luxury SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_SUV</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Sports Car</th>
<th data-quarto-table-cell-role="th">Vehicle Class_Two-Door Car</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Medsize</th>
<th data-quarto-table-cell-role="th">Vehicle Size_Small</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2763.519279</td>
<td>56274</td>
<td>69</td>
<td>32</td>
<td>5</td>
<td>0</td>
<td>1</td>
<td>384.811147</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>6979.535903</td>
<td>0</td>
<td>94</td>
<td>13</td>
<td>42</td>
<td>0</td>
<td>8</td>
<td>1131.464935</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12887.431650</td>
<td>48767</td>
<td>108</td>
<td>18</td>
<td>38</td>
<td>0</td>
<td>2</td>
<td>566.472247</td>
<td>False</td>
<td>True</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7645.861827</td>
<td>0</td>
<td>106</td>
<td>18</td>
<td>65</td>
<td>0</td>
<td>7</td>
<td>529.881344</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2813.692575</td>
<td>43836</td>
<td>73</td>
<td>12</td>
<td>44</td>
<td>0</td>
<td>1</td>
<td>138.130879</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9229</td>
<td>13778.969547</td>
<td>88811</td>
<td>189</td>
<td>28</td>
<td>82</td>
<td>1</td>
<td>5</td>
<td>477.453270</td>
<td>True</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9230</td>
<td>6330.546211</td>
<td>60118</td>
<td>83</td>
<td>29</td>
<td>58</td>
<td>4</td>
<td>5</td>
<td>9013.022660</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9231</td>
<td>6903.242487</td>
<td>40867</td>
<td>88</td>
<td>11</td>
<td>63</td>
<td>3</td>
<td>8</td>
<td>1653.198370</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9232</td>
<td>5676.751999</td>
<td>6668</td>
<td>79</td>
<td>30</td>
<td>55</td>
<td>1</td>
<td>8</td>
<td>3569.974780</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9233</td>
<td>17381.584589</td>
<td>31278</td>
<td>260</td>
<td>32</td>
<td>6</td>
<td>2</td>
<td>8</td>
<td>118.834310</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>9234 rows  51 columns</p>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>